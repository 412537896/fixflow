<?xml version="1.0" encoding="UTF-8"?>
<definitions id="definitions" xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL"
  xmlns:fix="c:/fix-bpmn-extens.xsd">
		
	<process id="financialReport" name="Monthly financial report reminder process" fix:dataobject="">
	
		<dataObject id="customer" name="客户" fix:dataobjectid="customer">
			<property id="ID" name="客户编号" value="ID"/>
		</dataObject>
		
		<extensionElements>
			  <!-- 流程扩展属性，属性值存放于流程示例processSubject的变量中，持久化时用该值更新流程实例表 -->
			  <!-- 该值可以被activity通过dataAssociation更新 -->
			  <fix:processSubject>
				  	<expression fix:actuator="simpleScriptActuator" >
				  		${year)年${month}月${department.getName(depid)}财务报告
				  	</expression>
			  </fix:processSubject>

			  <fix:dueDate>
				  	<expression fix:actuator="simpleScriptActuator" >
				  		flowInst.createTime+2d
				  	</expression>
			  </fix:dueDate>
		</extensionElements>
				
		<startEvent id="theStart" fix:formUri="form/sys/writeReport.html"/>
		
		<sequenceFlow id="flow1" sourceRef="theStart" targetRef="writeReportTask" /> 
		
		<!-- fix:isFirstUserTask 表示第一个用户任务节点，第一次创建该任务示例时自动执行 -->
		<userTask id="writeReportTask" name="填写月度财务报告" 
				  fix:formUri="form/sys/writeReport.html" default="flow3"> 
			  <documentation> 
			    Write monthly financial report for publication to shareholders. 
			  </documentation> 
			
				<extensionElements>
					  <fix:taskSubject>
						  	<expression >
						  		${year}年${month}月${department.getName(depid)}财务报告
						  	</expression>
					  </fix:taskSubject>
				
					  <fix:dueDate>
						  	<expression fix:actuator="simpleScriptActuator" >
						  		taskInst.createTime+2d
						  	</expression>
					  </fix:dueDate>
				</extensionElements>
				 
		  <!-- 设置候选处理人 -->
		  <potentialOwner> 
		    <resourceAssignmentExpression>
			  <!-- Actuator和类的对应关系由配置文件决定 -->
		      <formalExpression actuator="simpleScriptActuator">processInstance.initiator</formalExpression> 
		    </resourceAssignmentExpression> 
		  </potentialOwner> 
		  
		  <!-- 加载任务分配事件， 用于给所有任务获选人发送邮件-->
		  <extensionElements>
			  <fix:taskListener fix:event="task-assign" >
			  	<expression fix:actuator="fixServiceProxy" fix:interface="mail.sendmail">
			    		<extensionElements>
							  <fix:parameterBinding parameterId="from" parameterName="发送地址">
								  	<expression fix:actuator="fixedValueActuator">管理员邮箱地址</expression>
							  </fix:parameterBinding>
							  <fix:parameterBinding parameterId="to" parameterName="接受地址">
								  	<expression fix:actuator="simpleScriptActuator">potentialOwners.getMailAdrr()</expression>
							  </fix:parameterBinding>
							  <fix:parameterBinding parameterId="mailsubject" parameterName="邮件主题">
								  	<expression fix:actuator="simpleScriptActuator">processInstance.getProcessSubject()</expression>
							  </fix:parameterBinding>
							   <fix:parameterBinding parameterId="mailContent" parameterName="邮件内容">
								  	<expression fix:actuator="simpleScriptActuator">
								  	
								  		<![CDATA[
								          <html>
								            <body>
								              Hello ${(male? 'Mr.','Mrs.')} {recipientName},<br/><br/>
								                 
								              As of {sysDate.Now}, your order has been <b>processed and shipped</b>.<br/><br/>
								                  
								              Kind regards,<br/>
								                  
								              TheCompany.
								            </body>
								          </html>
								        ]]>
								        
								  	</expression>
							  </fix:parameterBinding>
						 </extensionElements>
			    </expression> 
			  </fix:taskListener>
		  </extensionElements>
		  
		</userTask> 
		
		<sequenceFlow id="flow2" sourceRef="writeReportTask" targetRef="gateway" /> 
		<!-- 排他网关 -->
		<complexGateway id="gateway" default="gatewayflow1" gatewayDirection=""/>
		
		<sequenceFlow id="gatewayflow1" sourceRef="gateway" targetRef="theEnd">
			<conditionExpression fix:actuator="simpleScriptActuator"> 
				<![CDATA[
				money > 100 && money < 250
				]]> 
			</conditionExpression> 
		</sequenceFlow>
		
		<sequenceFlow id="gatewayflow2" sourceRef="gateway" targetRef="verifyReportTask" /> 
		
		<userTask id="verifyReportTask" name="确认月度财务报告" 
			fix:formUri="form/sys/verifyReport.html"> 
			<documentation> 
			  Verify monthly financial report composed by the accountancy department. 
			  This financial report is going to be sent to all the company shareholders.   
			</documentation> 
			<!-- 设置处理人 -->
			<potentialOwner name="角色[经理]" fix:resouceRoleType="Role">
			  <resourceAssignmentExpression>
			 		<!-- Actuator和类的对应关系由配置文件决定 -->
			    	<formalExpression fix:actuator="fixedValueActuator">jingli</formalExpression> 
			  </resourceAssignmentExpression> 
			</potentialOwner> 

			<potentialOwner name="用户[张三]" fix:resouceRoleType="User">
			  <resourceAssignmentExpression>
			 		<!-- Actuator和类的对应关系由配置文件决定 -->
			    	<formalExpression fix:actuator="fixedValueActuator">zhang_san</formalExpression> 
			  </resourceAssignmentExpression> 
			</potentialOwner> 

			<potentialOwner name="部门[财务部]" fix:resouceRoleType="Dept">
			  <resourceAssignmentExpression>
			 		<!-- Actuator和类的对应关系由配置文件决定 -->
			    	<formalExpression fix:actuator="fixedValueActuator">caiwubu</formalExpression> 
			  </resourceAssignmentExpression> 
			</potentialOwner> 
			
			<potentialOwner name="表单数据[执行人]" fix:resouceRoleType="User">
			  <resourceAssignmentExpression>
			 		<!-- Actuator和类的对应关系由配置文件决定 -->
			    	<formalExpression fix:actuator="simpleScriptActuator">user_id</formalExpression> 
			  </resourceAssignmentExpression> 
			</potentialOwner> 

			<potentialOwner name="本部门经理" fix:resouceRoleType="User">
				<resourceAssignmentExpression>
			 		<!-- Actuator和类的对应关系由配置文件决定 -->
			    	<formalExpression fix:actuator="fixServiceProxy" fix:interface="performer.getOrgRoleMember">
			    		<extensionElements>
							  <fix:parameterBinding parameterId="arg1" parameterName="部门">
								  	<expression Action="simpleScriptActuator">loginUser.depid</expression>
							  </fix:parameterBinding>
							  <fix:parameterBinding parameterId="arg2" parameterName="角色">
								  	<expression Action="fixedValueActuator">jingli</expression>
							  </fix:parameterBinding>
						 </extensionElements>
			    	</formalExpression> 
			  	</resourceAssignmentExpression> 
			</potentialOwner> 
<extensionElements>

			<fix:userCommand id="ok" name="同意">
			</fix:userCommand>
			
			<fix:userCommand id="noOk" name="不同意">
			</fix:userCommand>
			
</extensionElements>
			
		</userTask> 
		
		<sequenceFlow id="flow3" name="往往" sourceRef="verifyReportTask" targetRef="theEnd" /> 
		
		 <!-- 为确认月度财务报告加载边界时间事件，用于任务超时处理 -->
		 <boundaryEvent id="verifyReportTaskboundaryEvent" 
		 		cancelActivity="true" attachedToRef="verifyReportTask">
		 		<!-- 任务到达5分钟自动执行task.complete()和 verifyReportTask.cansel()-->
		 		<timerEventDefinition>
	               	 	<timeDuration>P5M</timeDuration>
	            </timerEventDefinition>
		 </boundaryEvent>
		
		<sequenceFlow id="flow4" sourceRef="verifyReportTaskboundaryEvent" targetRef="scriptTask" />
		
		<serviceTask id="reportArchive" name="报表归档" fix:resultVariable="isReportArchiveOK">
		 	 <extensionElements>
			      <formalExpression fix:actuator="fixServiceProxy">
			      	${report.Archive(BizKey)}
			      </formalExpression>
			  </extensionElements>
		</serviceTask>
		

		<sequenceFlow id="flow5" sourceRef="verifyReportTaskboundaryEvent" targetRef="theEnd" />
		
		<scriptTask id="scriptTask" name="报表归档" fix:resultVariable="isReportArchiveOK">
		 	 <script>
				  System.out.println("HELLO! this is scriptTask"!);     
			 </script>
		</scriptTask>

		<endEvent id="theEnd"/>  
		
	 </process>

</definitions>
