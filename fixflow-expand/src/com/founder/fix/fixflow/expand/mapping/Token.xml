<?xml version="1.0" encoding="UTF-8"?>
<sqlmappingconfig:RulesConfig id="token" xmlns:sqlmappingconfig="http://www.founderfix.com/sqlmappingconfig">


	<!-- 任务表 -->
	<dataBaseTable tableId="fixflow_run_token" tableName="令牌表" tableValue="FIXFLOW_RUN_TOKEN">
		<column column="TOKEN_ID" name="令牌编号" jdbcType="VARCHAR" />
		<column column="NAME" name="令牌名称" jdbcType="VARCHAR" />
		<column column="START_TIME" name="开始时间" jdbcType="TIMESTAMP" />
		<column column="END_TIME" name="结束时间" jdbcType="TIMESTAMP" />
		<column column="NODEENTER_TIME" name="进入节点时间" jdbcType="TIMESTAMP" />
		<column column="ISABLETOREACTIVATEPARENT" name="在创建分支令牌为true,当子令牌到达join是会被设为false." jdbcType="VARCHAR" />
		<column column="ISSUSPENDED" name="是否停止" jdbcType="VARCHAR" />
		<column column="TOKEN_LOCK" name="令牌是否被锁定" jdbcType="VARCHAR" />
		<column column="NODE_ID" name="节点编号" jdbcType="VARCHAR" />
		<column column="PROCESSINSTANCE_ID" name="流程实例编号" jdbcType="VARCHAR" />
		<column column="PARENT_ID" name="父令牌编号" jdbcType="VARCHAR" />
		<column column="ISSUBPROCESSROOTTOKEN" name="是否是子流程根令牌" jdbcType="VARCHAR" />
		<column column="FREETOKEN" name="是否为自由令牌" jdbcType="VARCHAR" />
		<column column="PARENT_FREETOKEN_ID" name="父自由令牌编号" jdbcType="VARCHAR" />
		<column column="ARCHIVE_TIME" name="归档时间" jdbcType="VARCHAR" />
	</dataBaseTable>
	
	<!-- 任务表 -->
	<resultMap id="tokenResultMap" name="任务表" type="com.founder.fix.fixflow.core.impl.runtime.TokenEntity">
		<result property="id" column="TOKEN_ID" name="令牌编号" jdbcType="VARCHAR" />
		<result property="name" column="NAME" name="令牌名称" jdbcType="VARCHAR" />
		<result property="processInstanceId" column="PROCESSINSTANCE_ID" name="流程实例编号" jdbcType="VARCHAR" />
		<result property="nodeId" column="NODE_ID" name="节点编号" jdbcType="VARCHAR" />
		<result property="parentTokenId" column="PARENT_ID" name="父令牌编号" jdbcType="VARCHAR" />
		<result property="parentFreeTokenId" column="PARENT_FREETOKEN_ID" name="父自由令牌编号" jdbcType="VARCHAR" />
		<result property="startTime" column="START_TIME" name="开始时间" jdbcType="TIMESTAMP" />
		<result property="endTime" column="END_TIME" name="令牌编号" jdbcType="TIMESTAMP" />
		<result property="nodeEnterTime" column="NODEENTER_TIME" name="节点进入时间" jdbcType="TIMESTAMP" />
		<result property="archiveTime" column="ARCHIVE_TIME" name="归档时间" jdbcType="TIMESTAMP" />
		<result property="lockedString" column="TOKEN_LOCK" name="令牌是否被锁定" jdbcType="VARCHAR" />
		<result property="suspendedString" column="ISSUSPENDED" name="是否停止" jdbcType="VARCHAR" />
		<result property="subProcessRootTokenString" column="ISSUBPROCESSROOTTOKEN" name="是否为子流程根令牌" jdbcType="VARCHAR" />
		<result property="ableToReactivateParentString" column="ISABLETOREACTIVATEPARENT" name="令牌编号" jdbcType="VARCHAR" />
		<result property="freeTokenString" column="FREETOKEN" name="是否为自由令牌" jdbcType="VARCHAR" />
		
	</resultMap>
	
	

	<insert id="insertToken" parameterType="com.founder.fix.fixflow.core.impl.runtime.TokenEntity" remark="插入新令牌">
	<![CDATA[ 
		sqlCommand.insert("FIXFLOW_RUN_TOKEN",parameter.getPersistentDbMap());
	]]>
	</insert>

	<delete id="编号" parameterType="入参类型" remark="备注">
	<![CDATA[ 
	
	]]>

	</delete>
	<update id="updateToken" parameterType="com.founder.fix.fixflow.core.impl.runtime.TokenEntity" remark="更新令牌">
	<![CDATA[ 
		objectParamWhere = { parameter.getId() };
		sqlCommand.update("FIXFLOW_RUN_TOKEN",  parameter.getPersistentDbMap(), " TOKEN_ID=?",objectParamWhere);
	]]>
	</update>

	<select id="findTokenById" parameterType="java.lang.String" resultMap="tokenResultMap" remark="查询单个令牌对象">
		sqlText = "SELECT * FROM FIXFLOW_RUN_TOKEN WHERE TOKEN_ID = ? ";
		objectParamWhere = new ArrayList();
		objectParamWhere.add(parameter);
		sqlCommand.queryForList(sqlText, objectParamWhere);
	</select>
	<businessRules id="getTokenPersistentDbMap" parameterType="com.founder.fix.fixflow.core.impl.runtime.TokenEntity" resultType="java.util.Map" remark="返回Task对象需要保存到数据的字段Map">
	<![CDATA[ 
	
		persistentState = new HashMap<String, Object>();
		persistentState.put("TOKEN_ID", parameter.getId());
		persistentState.put("NAME", parameter.getName());
		persistentState.put("PROCESSINSTANCE_ID", parameter.getProcessInstanceId());
		persistentState.put("NODE_ID", parameter.getNodeId());
		persistentState.put("PARENT_ID", parameter.getParentTokenId());
		persistentState.put("PARENT_FREETOKEN_ID", parameter.getParentFreeTokenId());
		persistentState.put("START_TIME", parameter.getStartTime());
		persistentState.put("END_TIME", parameter.getEndTime());
		persistentState.put("NODEENTER_TIME", parameter.getNodeEnterTime());
		persistentState.put("ARCHIVE_TIME", parameter.getArchiveTime());
		persistentState.put("TOKEN_LOCK", String.valueOf(parameter.getlock()));
		persistentState.put("ISSUSPENDED", String.valueOf(parameter.isSuspended()));
		persistentState.put("ISSUBPROCESSROOTTOKEN", String.valueOf(parameter.isSubProcessRootToken()));
		persistentState.put("ISABLETOREACTIVATEPARENT", String.valueOf(parameter.isAbleToReactivateParent()));
		persistentState.put("FREETOKEN", String.valueOf(parameter.isFreeToken()));
		extensionFields=parameter.getExtensionFields();	
		for (String key : extensionFields.keySet()) {
			persistentState.put(key, extensionFields.get(key));
		}
		return persistentState;
		
	]]>
	</businessRules>
	
	
	<businessRules id="getTokenPersistentState" parameterType="com.founder.fix.fixflow.core.impl.runtime.TokenEntity" resultType="java.util.Map" remark="将Token对象转换成Map用来数据传递">
	<![CDATA[ 
		objectParam = new HashMap<String, Object>();
		objectParam.put("tokenId", parameter.getId());
		objectParam.put("name", parameter.getName());
		objectParam.put("startTime", parameter.getStartTime());
		objectParam.put("endTime", parameter.getEndTime());
		objectParam.put("nodeEnterTime", parameter.getNodeEnterTime());
		objectParam.put("isAbleToReactivateParent", String.valueOf(parameter.isAbleToReactivateParent()));
		objectParam.put("isSubProcessRootToken", String.valueOf(parameter.isSubProcessRootToken()));
		objectParam.put("isSuspended", String.valueOf(parameter.isSuspended()));
		objectParam.put("isLocked", String.valueOf(parameter.getlock()));
		objectParam.put("nodeId", parameter.getNodeId());
		objectParam.put("processInstanceId", parameter.getProcessInstanceId());
		objectParam.put("parentTokenId", parameter.getParentTokenId());
		objectParam.put("archiveTime", parameter.getArchiveTime());
		objectParam.put("freeToken", String.valueOf(parameter.isFreeToken()));
		objectParam.put("parentFreeTokenId", parameter.getParentFreeTokenId());
		
		persistenceExtensionFields=parameter.getPersistenceExtensionFields();	
		for (String key : persistenceExtensionFields.keySet()) {
			objectParam.put(key, persistenceExtensionFields.get(key));	
		}
		return objectParam;
	]]>
	</businessRules>
	
	<businessRules id="tokenClone" parameterType="com.founder.fix.fixflow.core.impl.runtime.TokenEntity" resultType="com.founder.fix.fixflow.core.impl.runtime.TokenEntity" remark="令牌实例拷贝">
	<![CDATA[ 
		tokenEntity = new TokenEntity();
		tokenEntity.persistentInit(sysRulesConfig.getResultMap("tokenResultMap"),parameter.getPersistentDbMap());
		return tokenEntity;
	]]>
	</businessRules>

</sqlmappingconfig:RulesConfig>
