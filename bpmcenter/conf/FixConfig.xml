<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<fixConfig>
	<bpaConf>
		<analysisEngine id="flowProcessAnalysis">
			<dataFeeds id="flowProcessAnalysis">
				<!-- 抽取时间维度  -->
				<dataFeed id="dimDateDataFeed" engine="dimDateDataFeed">
					<tigger value="234"/>
					<workspace>
						<source key="bpmDB" value="DB_BPA_BASE"/>
					</workspace>
					<outPutDB value="DB_BPA_BASE2"/>
				</dataFeed>

				<dataFeed id="processDef" engine="processDefDataFeed">
					<tigger value="234"/>
					<workspace>
						<source key="bpmDB" value="DB_BPA_BASE"/>
					</workspace>
					<outPutDB value="DB_BPA_BASE2"/>
				</dataFeed>
				
				<dataFeed id="processInstance" engine="processInstanceDataFeed">
					<tigger value="234"/>
					<workspace>
						<source key="bpmDB" value="DB_BPA_BASE"/>
					</workspace>
					<outPutDB value="DB_BPA_BASE2"/>
					<item>
					    <key>FIXFLOW_RUN_PROCESSINSTANECE</key>
					    <value>
					        SELECT FRP.*,FDP.PROCESS_NAME,FDP.VERSION  FROM FIXFLOW_RUN_PROCESSINSTANCE FRP LEFT JOIN FIXFLOW_DEF_PROCESSDEFINITION FDP ON FDP.PROCESS_ID = FRP.PROCESSDEFINITION_ID
					    </value>
					</item>
				</dataFeed>
				<dataFeed id="taskInstance" engine="taskInstanceDataFeed">
					<tigger value="234"/>
					<workspace>
						<source key="bpmDB" value="DB_BPA_BASE"/>
					</workspace>
					<outPutDB value="DB_BPA_BASE2"/>
					<item>
		    			<key>FIXFLOW_RUN_TASKINSTANCE</key>
		    			<!-- 此处必须要根据 PROCESSINSTANCE_ID 使数据块的PROCESSINSTANCE_ID连续-->
		    			<value>
		       	 			SELECT * FROM FIXFLOW_RUN_TASKINSTANCE WHERE ASSIGNEE IS NOT NULL ORDER BY PROCESSINSTANCE_ID
		    			</value>
					</item>
					<item>
						<key>updateProcessInstanceSql</key>
						<!-- 要更新的字段在代码里面自动组装 -->
						<value>UPDATE FIXBPA_FLOW_PROCESSINSTANCE SET</value>
					</item>
					<item>
						<!-- 流程中命令类型的ID，多个以,(逗号)分隔 -->
						<key>commandType</key>
						<value>rollBack,rollBackTaskPreviousStep,rollBackTaskByTaskId,rollBackTaskByExpression</value>
					</item>
				</dataFeed>

				<dataFeed id="dimUser" engine="dimUserDataFeed">
					<tigger value="234"/>
					<workspace>
						<source key="bpmDB" value="DB_BPA_BASE"/>
					</workspace>
					<outPutDB value="DB_BPA_BASE2"/>
					<!-- 人员信息和组织的直属关系 -->
					<item>
						<key>groupInfo</key>
						<value>
							select USERID as USERID,
							       USERNAME as USERNAME
							  from AU_USERINFO
						</value>
					</item>
				</dataFeed>
				<dataFeed id="dimOrg" engine="dimOrgDataFeed">
					<tigger value="234"/>
					<workspace>
						<source key="bpmDB" value="DB_BPA_BASE"/>
					</workspace>
					<outPutDB value="DB_BPA_BASE2"/>
					<item>
						<key>deleteCondition</key>
						<value>GROUPTYPE = 'org'</value>
					</item>
					<!-- 已经有层次的组织结构，人员信息具有从最顶层组织到它直属组织的信息都已经存在 -->
					<!-- 例子: select a as USERID,b as USERNAME, c as GROUPID , d as GROUPNAME, e as PARENTGROUPID, f as GROUPTYPE, g as ISPROPERTY from xxxx  -->
					<!-- ISPROPERTY 标识当前用户和组织是否是直属的关系，1表示直属，0表示非直属 -->
					
					<item>
						<key>hasLevelGroup</key>
						<!-- true 标识有层次结构的数据，false标识无层次结构的数据，如果不填写默认为true -->
						<value>true</value>
					</item>
					<item>
						<key>deleteCondition</key>
						<value>GROUPTYPE='org'</value>
					</item>
					<!-- 只存在人员信息和它直属组织的关系，并且组织之间具有父子关系 -->
					<!-- 组织之间的父子关系 -->
					<item>
						<key>department</key>
						<value>select ORGID as GROUPID, ORGNAME as GROUPNAME, SUPORGID as PARENTGROUPID,'org' as GROUPTYPE from AU_ORGINFO</value>
					</item>
					<!-- 人员信息和组织的直属关系 -->
					<item>
						<key>groupInfo</key>
						<value>
				              select t1.USERID as USERID,
				                     t3.USERNAME as USERNAME,
				                     t1.ORGID as GROUPID,
				                     t2.orgname as GROUPNAME,
				                     t2.suporgid as PARENTGROUPID,
				                     'org' as GROUPTYPE
				                from AU_ORGMEMBER t1, AU_ORGINFO t2, AU_USERINFO t3
				               where t1.orgid = t2.orgid
				                 and t1.USERID = t3.userid
						</value>
					</item>
				</dataFeed>
				<dataFeed id="dimRole" engine="dimOrgDataFeed">
					<tigger value="234"/>
					<workspace>
						<source key="bpmDB" value="DB_BPA_BASE"/>
					</workspace>
					<outPutDB value="DB_BPA_BASE2"/>
					<!-- 删除时候的条件 -->
					<item>
						<key>deleteCondition</key>
						<value>GROUPTYPE = 'role'</value>
					</item>
					<!-- 已经有层次的组织结构，人员信息具有从最顶层组织到它直属组织的信息都已经存在 -->
					<!-- 例子: select a as USERID,b as USERNAME, c as GROUPID , d as GROUPNAME, e as PARENTGROUPID, f as GROUPTYPE, g as ISPROPERTY from xxxx  -->
					<!-- ISPROPERTY 标识当前用户和组织是否是直属的关系，1表示直属，0表示非直属 -->
					
					<item>
						<key>hasLevelGroup</key>
						<!-- true 标识有层次结构的数据，false标识无层次结构的数据，如果不填写默认为true -->
						<value>false</value>
					</item>
					<!-- 只存在人员信息和它直属组织的关系，并且组织之间具有父子关系 -->
					<!-- 组织之间的父子关系 -->
					
					<item>
						<key>deleteCondition</key>
						<value>GROUPTYPE='role'</value>
					</item>
					<item>
						<key>department</key>
						<value></value>
					</item>
					<!-- 人员信息和组织的直属关系 -->
					<item>
						<key>groupInfo</key>
						<value>
				              select t1.USERID as USERID,
				                     t3.USERNAME as USERNAME,
				                     t1.ROLEID as GROUPID,
				                     t2.NAME as GROUPNAME,
				                     '' as PARENTGROUPID,
				                     'role' as GROUPTYPE
				                from AU_ROLEMEMBER t1, AU_ROLEINFO t2, AU_USERINFO t3
				               where t1.ROLEID = t2.ROLEID
				                 and t1.USERID = t3.userid
						</value>
					</item>
				</dataFeed>
				
			</dataFeeds>
			<dataPushers>
				<dataPusher id="analysisDataPusherDB" engine="analysisDataPusherDB">
					<tigger value="234"/>
					<workspace>
						<source key="bpmDB" value="BPA_OLAP_DS"/>
					</workspace>
					<outPutDB value="DB_BPA_BASE2"/>
					
					<mdx id="1.1" target="olap1">
						<columns>
							<column id="PROCESS_NAME" targetId="process_name" type="varchar(50)"/>
							<column id="ALL_COUNT" targetId="all_count" type="varchar(50)"/>						
						</columns>
						<content>
							select {Measures.[ALL_COUNT]} ON COLUMNS, 
							{[PROCESSDEFINITION_DEFKEY].MEMBERS} ON ROWS 
							from PROCESSINSTANCE_CUBE  							
						</content>
					</mdx>
		 		
					<mdx id="1.2"  target="olap2">
						<columns>
							<column id="PROCESSDEFINITION_ID" targetId="processdefinition_id" type="varchar(500)"/>
							<column id="PROCESS_NAME" targetId="process_name" type="varchar(50)"/>
							<column id="ALL_COUNT" targetId="all_count" type="numeric(18,0)"/>						
						</columns>
						<content>
							select {Measures.[ALL_COUNT]} ON COLUMNS, 
							{[PROCESSDEFINITION_DEFKEY].[ApplyBusinessCard].CHILDREN} ON ROWS 
							from PROCESSINSTANCE_CUBE  							
						</content>
					</mdx>
		<!--	-->								
					<mdx id="2.1" parentId = "1.2" target="olap3">
						<columns>
							<column id="NODE_ID" targetId="node_id" type="varchar(50)"/>
							<column id="NODE_NAME" targetId="node_name" type="varchar(50)"/>
							<column id="ALL_COUNT" targetId="all_count" type="numeric(18,0)"/>						
						</columns>
						<content>
							select {Measures.[ALL_COUNT], Measures.[DONE_COUNT]} ON COLUMNS, 
							{PROCESS_DEF.[PROCESSDEFINITION_ID].[{$parentMDX.PROCESSDEFINITION_ID}].CHILDREN} ON ROWS 
							from task_instance_cube  							
						</content>
					</mdx>	
					
					<mdx id="3.1" parentId = "2.1" target="olap4">
						<columns>							
							<column id="NODE_ID" targetId="node_id" type="varchar(50)"/>	
							<column id="USER_NAME" targetId="user_name" type="varchar(50)"/>						
							<column id="ALL_COUNT" targetId="all_count" type="numeric(18,0)"/>						
						</columns>
						<content>
							select {Measures.[ALL_COUNT],Measures.[DONE_COUNT]} ON COLUMNS,
							Filter([USER_ID].MEMBERS,Measures.[ALL_COUNT] >0) ON ROWS 
							from task_instance_cube  
							where ([PROCESSDEFINITION_ID].[ApplyBusinessCard:1:3ce5ad1c-cb9e-4169-a720-3287f2669e05].[{$parentMDX.NODE_ID}])							
						</content>
					</mdx>	
					
					<mdx id="3.2" parentId = "2.1" target="olap2">
						<columns>
							<column id="PROCESSDEFINITION_ID" targetId="processdefinition_id" type="varchar(500)"/>
							<column id="PROCESS_NAME" targetId="process_name" type="varchar(50)" />
							<column id="ALL_COUNT" targetId="all_count" type="numeric(18,0)"/>						
						</columns>
						<content>
							select {Measures.[ALL_COUNT]} ON COLUMNS, 
							{[PROCESSDEFINITION_DEFKEY].[applycar].CHILDREN} ON ROWS 
							from PROCESSINSTANCE_CUBE  							
						</content>
					</mdx>
			
				</dataPusher>
			</dataPushers>
		</analysisEngine>
	</bpaConf>
</fixConfig>
